generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

model User {
    id                     String          @id @default(cuid())
    email                  String          @unique
    name                   String?
    passwordHash           String
    avatar                 String?
    isVerified             Boolean         @default(false)
    createdAt              DateTime        @default(now())
    updatedAt              DateTime        @updatedAt
    lastLogin              DateTime?
    globalRole             GlobalRole      @default(USER)
    mfaEnabled             Boolean         @default(false)
    mfaSecret              String?
    auditLogs              AuditLog[]
    ownedCompanies         CompanyOwner[]
    employeeProfiles       Employee[]
    approvedInvoices       Invoice[]       @relation("InvoiceApprover")
    approvedPurchaseOrders PurchaseOrder[] @relation("PurchaseOrderApprover")
    sessions               Session[]
}

model Session {
    id        String   @id @default(cuid())
    userId    String
    token     String   @unique
    ipAddress String?
    userAgent String?
    expiresAt DateTime
    createdAt DateTime @default(now())
    user      User     @relation(fields: [userId], references: [id])

    @@index([userId])
}

model CompanyOwner {
    id        String      @id @default(cuid())
    userId    String
    companyId String
    role      CompanyRole @default(OWNER)
    isActive  Boolean     @default(true)
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt
    company   Company     @relation(fields: [companyId], references: [id])
    user      User        @relation(fields: [userId], references: [id])

    @@unique([userId, companyId])
}

model Company {
    id               String            @id @default(cuid())
    entityName       String
    country          String
    currency         String
    flag             String
    slug             String            @unique
    logo             String?
    primaryColor     String?
    secondaryColor   String?
    domain           String?           @unique
    status           CompanyStatus     @default(ACTIVE)
    subscriptionPlan SubscriptionPlan? @default(FREE)
    createdAt        DateTime          @default(now())
    updatedAt        DateTime          @updatedAt
    activity         String?
    address          String?
    bp               String?
    capital          String?
    city             String?
    email            String?
    legalForm        String?
    manager          String?
    ncc              String?
    phone            String?
    rccm             String?
    sector           String?
    tvaRate          Float?            @default(18.0)
    accounting       AccountingEntry[]
    apiKeys          ApiKey[]
    attendances      Attendance[]
    auditLogs        AuditLog[]
    owners           CompanyOwner[]
    contacts         ContactCrm[]
    currencies       Currency[]
    deals            Deal[]
    dictionaries     Dictionary[]
    employees        Employee[]
    fileResources    FileResource[]
    invoices         Invoice[]
    jobOpenings      JobOpening[]
    leaveRequests    LeaveRequest[]
    payslips         Payslip[]
    printerSettings  PrinterSettings?
    purchaseOrders   PurchaseOrder[]
    quotes           Quote[]
    stockCategories  StockCategory[]
    stockItems       StockItem[]
    stockMovements   StockMovement[]
    suppliers        Supplier[]
    supportTickets   SupportTicket[]
    tasks            Task[]
    geminiKey        String? // Cl√© API Google Gemini pour l'IA
    webhooks         Webhook[]

    @@index([entityName])
    @@index([country])
}

model Employee {
    id                         String          @id @default(cuid())
    matricule                  String
    fullName                   String
    position                   String
    department                 String
    email                      String
    phone                      String
    address                    String
    baseSalary                 Float
    status                     EmployeeStatus  @default(ACTIVE)
    contractType               ContractType
    userId                     String?
    companyId                  String
    role                       EmployeeRole    @default(EMPLOYEE)
    accessLevel                AccessLevel     @default(BASIC)
    temporaryPassword          String?
    temporaryPasswordExpiresAt DateTime?
    lastLogin                  DateTime?
    joinDate                   DateTime
    leaveDate                  DateTime?
    createdAt                  DateTime        @default(now())
    updatedAt                  DateTime        @updatedAt
    roleId                     String?
    faceDescriptor             String?
    attendances                Attendance[]
    company                    Company         @relation(fields: [companyId], references: [id])
    customRole                 Role?           @relation(fields: [roleId], references: [id])
    user                       User?           @relation(fields: [userId], references: [id])
    leaveRequests              LeaveRequest[]
    payslips                   Payslip[]
    supportTickets             SupportTicket[]
    assignedTasks              Task[]
    permissions                Permission[]    @relation("EmployeeToPermission")

    @@unique([companyId, matricule])
    @@unique([companyId, email])
    @@index([companyId, status])
    @@index([companyId, department])
}

model Permission {
    id          String           @id @default(cuid())
    code        String           @unique
    name        String
    description String
    category    String
    createdAt   DateTime         @default(now())
    updatedAt   DateTime         @updatedAt
    roles       RolePermission[]
    employees   Employee[]       @relation("EmployeeToPermission")
}

model Role {
    id          String           @id @default(cuid())
    name        String           @unique
    description String
    level       Int
    isDefault   Boolean          @default(false)
    createdAt   DateTime         @default(now())
    updatedAt   DateTime         @updatedAt
    employees   Employee[]
    permissions RolePermission[]
}

model RolePermission {
    id           String     @id @default(cuid())
    roleId       String
    permissionId String
    createdAt    DateTime   @default(now())
    permission   Permission @relation(fields: [permissionId], references: [id])
    role         Role       @relation(fields: [roleId], references: [id])

    @@unique([roleId, permissionId])
}

model StockItem {
    id                 String              @id @default(cuid())
    type               String
    ref                String
    name               String
    category           String?
    quantity           Int
    unit               String
    minThreshold       Int
    location           String
    value              Float
    sellingPrice       Float
    status             String
    companyId          String
    createdAt          DateTime            @default(now())
    updatedAt          DateTime            @updatedAt
    barcode            String?
    brand              String?
    description        String?
    imageUrl           String?
    categoryId         String?
    supplierId         String?
    batchNumber        String?
    expiryDate         DateTime?
    manufacturingDate  DateTime?
    purchaseOrderItems PurchaseOrderItem[]
    categoryRel        StockCategory?      @relation(fields: [categoryId], references: [id])
    company            Company             @relation(fields: [companyId], references: [id])
    supplier           Supplier?           @relation(fields: [supplierId], references: [id])
    movements          StockMovementItem[]
    tasks              Task[]

    @@unique([companyId, ref])
    @@index([barcode])
}

model StockCategory {
    id        String      @id @default(cuid())
    name      String
    companyId String
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt
    company   Company     @relation(fields: [companyId], references: [id])
    items     StockItem[]

    @@unique([companyId, name])
}

model Supplier {
    id             String          @id @default(cuid())
    name           String
    contactName    String
    email          String
    phone          String
    address        String
    category       String
    companyId      String
    createdAt      DateTime        @default(now())
    updatedAt      DateTime        @updatedAt
    purchaseOrders PurchaseOrder[]
    stockItems     StockItem[]
    stockMovements StockMovement[]
    company        Company         @relation(fields: [companyId], references: [id])
    tasks          Task[]
}

model StockMovement {
    id          String              @id @default(cuid())
    type        String
    reference   String
    date        DateTime
    partnerId   String
    partnerName String
    status      String
    totalValue  Float
    companyId   String
    supplierId  String?
    createdAt   DateTime            @default(now())
    updatedAt   DateTime            @updatedAt
    company     Company             @relation(fields: [companyId], references: [id])
    supplier    Supplier?           @relation(fields: [supplierId], references: [id])
    items       StockMovementItem[]

    @@unique([companyId, reference])
}

model StockMovementItem {
    id              String        @id @default(cuid())
    stockMovementId String
    stockItemId     String
    description     String
    quantity        Int
    unitPrice       Float
    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt
    stockItem       StockItem     @relation(fields: [stockItemId], references: [id])
    stockMovement   StockMovement @relation(fields: [stockMovementId], references: [id])
}

model Payslip {
    id              String   @id @default(cuid())
    employeeId      String
    employeeName    String
    period          String
    date            DateTime
    baseSalary      Float
    transportPrime  Float
    housingPrime    Float
    otherBonuses    Float
    grossSalary     Float
    cnpsDeduction   Float
    taxDeduction    Float
    otherDeductions Float
    netSalary       Float
    status          String
    companyId       String
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt
    cnpsEmployer    Float    @default(0)
    taxEmployer     Float    @default(0)
    totalEmployer   Float    @default(0)
    company         Company  @relation(fields: [companyId], references: [id])
    employee        Employee @relation(fields: [employeeId], references: [id])
}

model AccountingEntry {
    id           String   @id @default(cuid())
    date         DateTime
    ref          String
    label        String
    category     String
    amount       Float
    currency     String?
    currencyRate Float?
    type         String
    status       String
    companyId    String
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt
    company      Company  @relation(fields: [companyId], references: [id])
}

model Quote {
    id           String      @id @default(cuid())
    reference    String
    clientId     String
    clientName   String
    date         DateTime
    validUntil   DateTime
    totalAmount  Float
    currency     String?
    currencyRate Float?
    status       String
    companyId    String
    createdAt    DateTime    @default(now())
    updatedAt    DateTime    @updatedAt
    contactCrmId String?
    invoices     Invoice[]
    company      Company     @relation(fields: [companyId], references: [id])
    contactCrm   ContactCrm? @relation(fields: [contactCrmId], references: [id])
    items        QuoteItem[]

    @@unique([companyId, reference])
}

model QuoteItem {
    id          String   @id @default(cuid())
    quoteId     String
    description String
    quantity    Int
    unitPrice   Float
    total       Float
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    quote       Quote    @relation(fields: [quoteId], references: [id])
}

model ContactCrm {
    id             String          @id @default(cuid())
    companyName    String
    contactName    String
    email          String
    phone          String
    address        String
    type           String
    status         String
    lastContact    DateTime
    industry       String
    companyId      String
    createdAt      DateTime        @default(now())
    updatedAt      DateTime        @updatedAt
    company        Company         @relation(fields: [companyId], references: [id])
    deals          Deal[]
    invoices       Invoice[]
    quotes         Quote[]
    supportTickets SupportTicket[]
    tasks          Task[]
}

model Deal {
    id           String     @id @default(cuid())
    title        String
    contactId    String
    amount       Float
    currency     String?
    currencyRate Float?
    stage        String
    probability  Int
    closingDate  DateTime
    companyId    String
    createdAt    DateTime   @default(now())
    updatedAt    DateTime   @updatedAt
    company      Company    @relation(fields: [companyId], references: [id])
    contact      ContactCrm @relation(fields: [contactId], references: [id])
}

model JobOpening {
    id          String   @id @default(cuid())
    title       String
    location    String
    type        String
    description String
    status      String
    companyId   String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    company     Company  @relation(fields: [companyId], references: [id])
}

model Invoice {
    id           String        @id @default(cuid())
    reference    String
    clientId     String?
    clientName   String
    date         DateTime
    dueDate      DateTime
    status       String
    totalAmount  Float
    paidAmount   Float         @default(0)
    currency     String?
    currencyRate Float?
    companyId    String
    quoteId      String?
    contactCrmId String?
    createdAt    DateTime      @default(now())
    updatedAt    DateTime      @updatedAt
    approvalNote String?
    approvedAt   DateTime?
    approvedById String?
    approvedBy   User?         @relation("InvoiceApprover", fields: [approvedById], references: [id])
    company      Company       @relation(fields: [companyId], references: [id])
    contactCrm   ContactCrm?   @relation(fields: [contactCrmId], references: [id])
    quote        Quote?        @relation(fields: [quoteId], references: [id])
    items        InvoiceItem[]
    payments     Payment[]

    @@unique([companyId, reference])
}

model InvoiceItem {
    id          String   @id @default(cuid())
    invoiceId   String
    description String
    quantity    Int
    unitPrice   Float
    total       Float
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    invoice     Invoice  @relation(fields: [invoiceId], references: [id])
}

model Payment {
    id        String   @id @default(cuid())
    reference String?
    amount    Float
    date      DateTime
    method    String
    notes     String?
    invoiceId String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    invoice   Invoice  @relation(fields: [invoiceId], references: [id])
}

model PurchaseOrder {
    id           String              @id @default(cuid())
    reference    String
    date         DateTime
    expectedDate DateTime?
    status       String
    totalAmount  Float
    companyId    String
    supplierId   String
    createdAt    DateTime            @default(now())
    updatedAt    DateTime            @updatedAt
    approvalNote String?
    approvedAt   DateTime?
    approvedById String?
    approvedBy   User?               @relation("PurchaseOrderApprover", fields: [approvedById], references: [id])
    company      Company             @relation(fields: [companyId], references: [id])
    supplier     Supplier            @relation(fields: [supplierId], references: [id])
    items        PurchaseOrderItem[]

    @@unique([companyId, reference])
}

model PurchaseOrderItem {
    id              String        @id @default(cuid())
    purchaseOrderId String
    stockItemId     String?
    description     String
    quantity        Int
    unitPrice       Float
    total           Float
    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt
    purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    stockItem       StockItem?    @relation(fields: [stockItemId], references: [id])
}

model Attendance {
    id         String    @id @default(cuid())
    date       DateTime
    checkIn    DateTime?
    checkOut   DateTime?
    status     String
    notes      String?
    employeeId String
    companyId  String
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt
    company    Company   @relation(fields: [companyId], references: [id])
    employee   Employee  @relation(fields: [employeeId], references: [id])

    @@unique([employeeId, date])
}

model LeaveRequest {
    id         String    @id @default(cuid())
    type       String
    startDate  DateTime
    endDate    DateTime
    reason     String?
    status     String
    approvedAt DateTime?
    employeeId String
    companyId  String
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt
    company    Company   @relation(fields: [companyId], references: [id])
    employee   Employee  @relation(fields: [employeeId], references: [id])
}

model Task {
    id             String      @id @default(cuid())
    title          String
    description    String?
    priority       String
    status         String
    dueDate        DateTime?
    assignedToId   String?
    companyId      String
    createdAt      DateTime    @default(now())
    updatedAt      DateTime    @updatedAt
    actualHours    Float?
    category       String?
    clientId       String?
    completedAt    DateTime?
    estimatedHours Float?
    productId      String?
    startDate      DateTime?
    supplierId     String?
    tags           String[]
    assignedTo     Employee?   @relation(fields: [assignedToId], references: [id])
    client         ContactCrm? @relation(fields: [clientId], references: [id])
    company        Company     @relation(fields: [companyId], references: [id])
    product        StockItem?  @relation(fields: [productId], references: [id])
    supplier       Supplier?   @relation(fields: [supplierId], references: [id])
}

model Dictionary {
    id        String   @id @default(cuid())
    type      String
    value     String
    code      String?
    color     String?
    companyId String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    company   Company  @relation(fields: [companyId], references: [id])

    @@unique([companyId, type, value])
    @@index([companyId, type])
}

model PrinterSettings {
    id              String   @id @default(cuid())
    documentPrinter String?
    barcodePrinter  String?
    labelWidth      Int      @default(50)
    labelHeight     Int      @default(30)
    companyId       String   @unique
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt
    company         Company  @relation(fields: [companyId], references: [id])
}

model AuditLog {
    id        String   @id @default(cuid())
    action    String
    entity    String
    entityId  String?
    oldValue  Json?
    newValue  Json?
    ipAddress String?
    userAgent String?
    userId    String?
    companyId String?
    createdAt DateTime @default(now())
    company   Company? @relation(fields: [companyId], references: [id])
    user      User?    @relation(fields: [userId], references: [id])

    @@index([companyId, entity])
    @@index([userId])
    @@index([createdAt])
}

model Webhook {
    id        String   @id @default(cuid())
    url       String
    events    String[]
    isActive  Boolean  @default(true)
    secret    String?
    companyId String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    company   Company  @relation(fields: [companyId], references: [id])

    @@index([companyId])
}

model ApiKey {
    id         String    @id @default(cuid())
    name       String
    key        String    @unique
    isActive   Boolean   @default(true)
    lastUsedAt DateTime?
    expiresAt  DateTime?
    companyId  String
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt
    company    Company   @relation(fields: [companyId], references: [id])

    @@index([companyId])
}

model FileResource {
    id         String         @id @default(cuid())
    name       String
    path       String
    mimeType   String
    size       Int
    version    Int            @default(1)
    tags       String[]
    ocrContent String?
    parentId   String?
    companyId  String
    createdAt  DateTime       @default(now())
    updatedAt  DateTime       @updatedAt
    company    Company        @relation(fields: [companyId], references: [id])
    parent     FileResource?  @relation("FileVersions", fields: [parentId], references: [id])
    versions   FileResource[] @relation("FileVersions")

    @@index([companyId])
}

model Currency {
    id        String         @id @default(cuid())
    code      String
    symbol    String
    name      String
    createdAt DateTime       @default(now())
    updatedAt DateTime       @updatedAt
    companyId String
    isActive  Boolean        @default(true)
    isBase    Boolean        @default(false)
    rate      Float          @default(1.0)
    company   Company        @relation(fields: [companyId], references: [id])
    ratesFrom ExchangeRate[] @relation("FromCurrency")
    ratesTo   ExchangeRate[] @relation("ToCurrency")

    @@unique([companyId, code])
}

model ExchangeRate {
    id             String   @id @default(cuid())
    fromCurrencyId String
    toCurrencyId   String
    rate           Float
    date           DateTime @default(now())
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt
    fromCurrency   Currency @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
    toCurrency     Currency @relation("ToCurrency", fields: [toCurrencyId], references: [id])

    @@unique([fromCurrencyId, toCurrencyId, date])
}

model SupportTicket {
    id            String          @id @default(cuid())
    reference     String
    subject       String
    category      String
    priority      String
    status        String
    contactId     String?
    assignedToId  String?
    customerName  String?
    customerEmail String?
    companyId     String
    createdAt     DateTime        @default(now())
    updatedAt     DateTime        @updatedAt
    assignedTo    Employee?       @relation(fields: [assignedToId], references: [id])
    company       Company         @relation(fields: [companyId], references: [id])
    contact       ContactCrm?     @relation(fields: [contactId], references: [id])
    messages      TicketMessage[]

    @@unique([companyId, reference])
    @@index([companyId, status])
}

model TicketMessage {
    id         String        @id @default(cuid())
    content    String
    senderId   String?
    isSystem   Boolean       @default(false)
    senderName String?
    ticketId   String
    createdAt  DateTime      @default(now())
    ticket     SupportTicket @relation(fields: [ticketId], references: [id])
}

enum GlobalRole {
    SUPER_ADMIN
    USER
}

enum CompanyStatus {
    ACTIVE
    INACTIVE
    SUSPENDED
}

enum CompanyRole {
    OWNER
    ADMIN
}

enum EmployeeStatus {
    ACTIVE
    INACTIVE
    ON_LEAVE
    TERMINATED
}

enum ContractType {
    CDI
    CDD
    FREELANCE
    INTERN
}

enum EmployeeRole {
    SUPER_ADMIN
    ADMIN
    MANAGER
    EMPLOYEE
    VIEWER
    GUEST
}

enum AccessLevel {
    NONE
    BASIC
    STANDARD
    PREMIUM
    ADMIN
}

enum SubscriptionPlan {
    FREE
    STARTER
    PROFESSIONAL
    ENTERPRISE
}
